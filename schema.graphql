# Enhanced Polymarket Subgraph Schema
# Optimized for performance following Graph Protocol best practices
# Avoids large arrays and uses @derivedFrom relationships

# =============================================================================
# CORE ENTITIES
# =============================================================================

type Global @entity(immutable: false) {
  "Singleton entity for global statistics"
  id: ID!
  
  # Market Statistics
  numConditions: Int!
  numOpenConditions: Int!
  numClosedConditions: Int!
  numMarkets: Int!
  numActiveMarkets: Int!
  
  # User Statistics
  numTraders: BigInt!
  numUniqueTraders: BigInt!
  
  # Trading Statistics
  tradesQuantity: BigInt!
  buysQuantity: BigInt!
  sellsQuantity: BigInt!
  
  # Volume Statistics (both raw and scaled)
  collateralVolume: BigInt!
  scaledCollateralVolume: BigDecimal!
  collateralBuyVolume: BigInt!
  scaledCollateralBuyVolume: BigDecimal!
  collateralSellVolume: BigInt!
  scaledCollateralSellVolume: BigDecimal!
  
  # Fee Statistics
  collateralFees: BigInt!
  scaledCollateralFees: BigDecimal!
  
  # Timestamps
  lastUpdated: BigInt!
}

type Account @entity(immutable: false) {
  "User address"
  id: ID!
  
  # Account metadata
  creationTimestamp: BigInt!
  lastSeenTimestamp: BigInt!
  lastTradedTimestamp: BigInt!
  isActive: Boolean!
  
  # Trading statistics
  numTrades: BigInt!
  collateralVolume: BigInt!
  scaledCollateralVolume: BigDecimal!
  
  # P&L tracking
  totalRealizedPnl: BigInt!
  scaledTotalRealizedPnl: BigDecimal!
  totalFeesPaid: BigInt!
  scaledTotalFeesPaid: BigDecimal!
  
  # Relationships using @derivedFrom (no large arrays)
  positions: [MarketPosition!] @derivedFrom(field: "user")
  transactions: [Transaction!] @derivedFrom(field: "user")
  splits: [Split!] @derivedFrom(field: "stakeholder")
  merges: [Merge!] @derivedFrom(field: "stakeholder")
  redemptions: [Redemption!] @derivedFrom(field: "redeemer")
  marketProfits: [MarketProfit!] @derivedFrom(field: "user")
}

type Collateral @entity(immutable: false) {
  "Token address"
  id: ID!
  name: String!
  symbol: String!
  decimals: Int!
  
  # Usage statistics
  numMarkets: Int!
  totalVolume: BigInt!
  scaledTotalVolume: BigDecimal!
  
  # Relationships using @derivedFrom
  splits: [Split!] @derivedFrom(field: "collateralToken")
  merges: [Merge!] @derivedFrom(field: "collateralToken")
  redemptions: [Redemption!] @derivedFrom(field: "collateralToken")
}

# =============================================================================
# CONDITIONAL TOKEN FRAMEWORK
# =============================================================================

type Condition @entity(immutable: false) {
  id: ID!
  oracle: Bytes!
  questionId: Bytes!
  outcomeSlotCount: Int!
  
  # Resolution data
  resolutionTimestamp: BigInt
  resolutionHash: Bytes
  payoutNumerators: [BigInt!]
  payoutDenominator: BigInt
  
  # Relationships using @derivedFrom (no large arrays)
  markets: [Market!] @derivedFrom(field: "condition")
  splits: [Split!] @derivedFrom(field: "condition")
  merges: [Merge!] @derivedFrom(field: "condition")
  redemptions: [Redemption!] @derivedFrom(field: "condition")
  marketProfits: [MarketProfit!] @derivedFrom(field: "condition")
  
  # Statistics
  numMarkets: Int!
  totalVolume: BigInt!
  scaledTotalVolume: BigDecimal!
}

type Market @entity(immutable: false) {
  "Market identifier (condition + outcome index)"
  id: ID!
  condition: Condition!
  outcomeIndex: BigInt!
  
  # Market metadata
  isActive: Boolean!
  isResolved: Boolean!
  resolutionTimestamp: BigInt
  
  # Trading data
  totalVolume: BigInt!
  scaledTotalVolume: BigDecimal!
  numTrades: BigInt!
  numBuyers: Int!
  numSellers: Int!
  
  # Price data
  currentPrice: BigDecimal
  
  # Relationships using @derivedFrom (no large arrays)
  positions: [MarketPosition!] @derivedFrom(field: "market")
  transactions: [Transaction!] @derivedFrom(field: "market")
  priceHistory: [PricePoint!] @derivedFrom(field: "market")
}

type PricePoint @entity(immutable: true) {
  "Timestamp + Market ID"
  id: ID!
  market: Market!
  timestamp: BigInt!
  price: BigDecimal!
  volume: BigInt!
  scaledVolume: BigDecimal!
}

# =============================================================================
# POSITION TRACKING
# =============================================================================

type MarketPosition @entity(immutable: false) {
  "User + Market ID"
  id: ID!
  user: Account!
  market: Market!
  
  # Position data
  quantityBought: BigInt!
  quantitySold: BigInt!
  netQuantity: BigInt!
  
  # Value tracking
  valueBought: BigInt!
  valueSold: BigInt!
  netValue: BigInt!
  feesPaid: BigInt!
  
  # P&L tracking
  realizedPnl: BigInt!
  scaledRealizedPnl: BigDecimal!
  unrealizedPnl: BigInt!
  scaledUnrealizedPnl: BigDecimal!
  
  # Timestamps
  firstTradeTimestamp: BigInt!
  lastTradeTimestamp: BigInt!
}

type MarketProfit @entity(immutable: false) {
  "User + Condition ID"
  id: ID!
  user: Account!
  condition: Condition!
  profit: BigInt!
  scaledProfit: BigDecimal!
}

# =============================================================================
# TRADING DATA
# =============================================================================

enum TradeType {
  Buy
  Sell
}

type Transaction @entity(immutable: true) {
  "Transaction hash"
  id: Bytes!
  type: TradeType!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Participants
  user: Account!
  market: Market!
  
  # Trade details
  tradeAmount: BigInt!
  feeAmount: BigInt!
  outcomeTokensAmount: BigInt!
  outcomeIndex: BigInt!
  
  # Price data
  price: BigDecimal!
  scaledPrice: BigDecimal!
  
  # Gas data
  gasUsed: BigInt!
  gasPrice: BigInt!
}

# =============================================================================
# ORDERBOOK DATA
# =============================================================================

type Orderbook @entity(immutable: false) {
  "Token ID"
  id: ID!
  
  # Trading statistics
  tradesQuantity: BigInt!
  buysQuantity: BigInt!
  sellsQuantity: BigInt!
  
  # Volume data
  collateralVolume: BigInt!
  scaledCollateralVolume: BigDecimal!
  collateralBuyVolume: BigInt!
  scaledCollateralBuyVolume: BigDecimal!
  collateralSellVolume: BigInt!
  scaledCollateralSellVolume: BigDecimal!
  
  # Fee data
  totalFees: BigInt!
  scaledTotalFees: BigDecimal!
  
  # Analytics
  averageTradeSize: BigDecimal!
  lastActiveDay: BigInt!
  
  # Relationships using @derivedFrom (no large arrays)
  orders: [OrderFilledEvent!] @derivedFrom(field: "orderbook")
}

type OrderFilledEvent @entity(immutable: true) {
  "Transaction hash + Order hash"
  id: Bytes!
  transactionHash: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Order details
  orderHash: Bytes!
  maker: Bytes!
  taker: Bytes!
  makerAssetId: BigInt!
  takerAssetId: BigInt!
  makerAmountFilled: BigInt!
  takerAmountFilled: BigInt!
  fee: BigInt!
  
  # Market data
  orderbook: Orderbook!
  side: String!
  price: BigDecimal!
  size: BigInt!
}

type OrdersMatchedEvent @entity(immutable: true) {
  "Transaction hash"
  id: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Match details
  makerAssetID: BigInt!
  takerAssetID: BigInt!
  makerAmountFilled: BigInt!
  takerAmountFilled: BigInt!
}

# =============================================================================
# POSITION MANAGEMENT
# =============================================================================

type Split @entity(immutable: true) {
  "Transaction hash"
  id: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Participants
  stakeholder: Account!
  collateralToken: Collateral!
  
  # Split details
  parentCollectionId: Bytes!
  condition: Condition!
  partition: [BigInt!]!
  amount: BigInt!
}

type Merge @entity(immutable: true) {
  "Transaction hash"
  id: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Participants
  stakeholder: Account!
  collateralToken: Collateral!
  
  # Merge details
  parentCollectionId: Bytes!
  condition: Condition!
  partition: [BigInt!]!
  amount: BigInt!
}

type Redemption @entity(immutable: true) {
  "Transaction hash"
  id: Bytes!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Participants
  redeemer: Account!
  collateralToken: Collateral!
  
  # Redemption details
  parentCollectionId: Bytes!
  condition: Condition!
  indexSets: [BigInt!]!
  payout: BigInt!
}

# =============================================================================
# ENHANCED ANALYTICS
# =============================================================================

type DailyStats @entity(immutable: false) {
  "YYYY-MM-DD format"
  id: ID!
  date: String!
  timestamp: BigInt!
  
  # Trading stats
  numTrades: BigInt!
  numTraders: Int!
  volume: BigInt!
  scaledVolume: BigDecimal!
  fees: BigInt!
  scaledFees: BigDecimal!
  
  # Market stats
  numActiveMarkets: Int!
  numNewMarkets: Int!
  numResolvedMarkets: Int!
}

type HourlyStats @entity(immutable: false) {
  "YYYY-MM-DD-HH format"
  id: ID!
  date: String!
  hour: Int!
  timestamp: BigInt!
  
  # Trading stats
  numTrades: BigInt!
  numTraders: Int!
  volume: BigInt!
  scaledVolume: BigDecimal!
  fees: BigInt!
  scaledFees: BigDecimal!
}
